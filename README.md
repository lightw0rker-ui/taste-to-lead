# taste-to-lead

## Project structure

- `client/`: React + Vite + Tailwind frontend
- `server/`: Express API + server bootstrap
- `shared/`: Drizzle schema/types shared across app
- `migrations/`: SQL migrations generated by Drizzle
- `script/build.ts`: production build script outputting `dist/`

## Why Cloud Run crashed with `relation "organizations" does not exist`

The app was starting with DB queries (`seedDatabase`) before the HTTP server listened, and schema changes were not tracked by deterministic SQL migrations. In a fresh Neon DB, tables such as `organizations` did not exist yet, so startup crashed before Cloud Run saw a listening process.

This repo now uses Drizzle migration files in `migrations/` and a startup flow that always listens first, then checks DB readiness in the background.

## Drizzle migration workflow

Set only `DATABASE_URL` and run:

```bash
npm run db:generate   # generate SQL migration files from shared/schema.ts
npm run db:migrate    # apply generated migrations to DATABASE_URL
npm run db:studio     # optional local inspection UI
```

## Neon setup (exact commands)

```bash
export DATABASE_URL="postgresql://neondb_owner:npg_6OJSMPBGA1la@ep-billowing-pond-ai1o1ral-pooler.c-4.us-east-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require"
npm run db:migrate
```

## Verify tables exist

Use either Drizzle Studio:

```bash
npm run db:studio
```

Or SQL (example with `psql`):

```bash
psql "$DATABASE_URL" -c "\dt"
psql "$DATABASE_URL" -c "select count(*) from organizations;"
```

## Production startup behavior

- Server listens quickly on `0.0.0.0:${PORT:-8080}`.
- `GET /healthz` returns `200` immediately without DB.
- If DB is unavailable or migrations are missing, the app logs `DB not ready: ...` and API routes return `503` JSON until ready.

## Deployment pipeline (service image + migrate image)

`cloudbuild.yaml` now builds and pushes two images:

- Service image: `${_SERVICE_NAME}:$COMMIT_SHA` (slim, devDependencies pruned)
- Migrate image: `${_MIGRATE_IMAGE_NAME}:$COMMIT_SHA` (includes devDependencies, including `drizzle-kit`)

### 1) Create/attach DATABASE_URL secret

```bash
gcloud secrets create DATABASE_URL --replication-policy=automatic
printf '%s' 'postgresql://<user>:<password>@<host>/<db>?sslmode=require&channel_binding=require' | \
  gcloud secrets versions add DATABASE_URL --data-file=-
```

### 2) Run migrations via Cloud Run Job (using migrate image)

```bash
gcloud run jobs deploy taste-to-lead-migrate \
  --image=us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/taste-to-lead-migrate:$COMMIT_SHA \
  --region=us-central1 \
  --set-secrets=DATABASE_URL=DATABASE_URL:latest \
  --max-retries=3 \
  --task-timeout=10m

gcloud run jobs execute taste-to-lead-migrate --region=us-central1 --wait
```

### 3) Deploy Cloud Run service (using service image)

```bash
gcloud run deploy taste-to-lead \
  --image=us-central1-docker.pkg.dev/$PROJECT_ID/cloud-run-source-deploy/taste-to-lead:$COMMIT_SHA \
  --region=us-central1 \
  --allow-unauthenticated \
  --port=8080 \
  --set-env-vars=NODE_ENV=production \
  --set-secrets=DATABASE_URL=DATABASE_URL:latest,SESSION_SECRET=SESSION_SECRET:latest,GOOGLE_AI_API_KEY=GOOGLE_AI_API_KEY:latest,RESEND_API_KEY=RESEND_API_KEY:latest
```

## Local verification commands

```bash
npm ci
npm run build
export DATABASE_URL="postgresql://neondb_owner:npg_6OJSMPBGA1la@ep-billowing-pond-ai1o1ral-pooler.c-4.us-east-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require"
npm run db:migrate
npm run start
```

## Docker acceptance checks

```bash
docker build --target migrate -t app-migrate .
docker run --rm -e DATABASE_URL="$DATABASE_URL" app-migrate
```

## Troubleshooting

- `sh: 1: drizzle-kit: not found` in migration job:
  - Ensure the job uses the migrate image (`taste-to-lead-migrate`) and not the slim service image.
- `DB not ready: missing tables: ...`:
  - Run `npm run db:migrate` with the correct `DATABASE_URL`.
- `DB not ready: connect ECONNREFUSED` or TLS/auth errors:
  - Verify Neon URL, SSL params, and Secret Manager value.
- `/healthz` works but `/api/*` returns `503`:
  - Expected until DB readiness check succeeds.
