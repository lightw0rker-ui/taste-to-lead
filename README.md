# taste-to-lead

## Project structure

- `client/`: React + Vite + Tailwind frontend
- `server/`: Express API + server bootstrap
- `shared/`: Drizzle schema/types shared across app
- `migrations/`: SQL migrations generated by Drizzle
- `script/build.ts`: production build script outputting `dist/`

## Why Cloud Run crashed with `relation "organizations" does not exist`

The app was starting with DB queries (`seedDatabase`) before the HTTP server listened, and schema changes were not tracked by deterministic SQL migrations. In a fresh Neon DB, tables such as `organizations` did not exist yet, so startup crashed before Cloud Run saw a listening process.

This repo now uses Drizzle migration files in `migrations/` and a startup flow that always listens first, then checks DB readiness in the background.

## Drizzle migration workflow

Set only `DATABASE_URL` and run:

```bash
npm run db:generate   # generate SQL migration files from shared/schema.ts
npm run db:migrate    # apply generated migrations to DATABASE_URL
npm run db:studio     # optional local inspection UI
```

## Neon setup (exact commands)

```bash
export DATABASE_URL="postgresql://neondb_owner:npg_6OJSMPBGA1la@ep-billowing-pond-ai1o1ral-pooler.c-4.us-east-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require"
npm run db:migrate
```

## Verify tables exist

Use either Drizzle Studio:

```bash
npm run db:studio
```

Or SQL (example with `psql`):

```bash
psql "$DATABASE_URL" -c "\dt"
psql "$DATABASE_URL" -c "select count(*) from organizations;"
```

## Production startup behavior

- Server listens quickly on `0.0.0.0:${PORT:-8080}`.
- `GET /healthz` returns `200` immediately without DB.
- If DB is unavailable or migrations are missing, the app logs `DB not ready: ...` and API routes return `503` JSON until ready.

## Deployment pipeline

`cloudbuild.yaml` no longer runs migrations on every deploy.

Recommended release order:

1. Build/deploy web service with Cloud Build.
2. Run migrations as a one-time/manual step (or Cloud Run Job) against the same `DATABASE_URL`:

```bash
export DATABASE_URL="<your neon connection string>"
npm ci
npm run db:migrate
```

This keeps deploys safe and avoids schema changes unexpectedly blocking image rollout.

## Local verification commands

```bash
npm ci
npm run build
export DATABASE_URL="postgresql://neondb_owner:npg_6OJSMPBGA1la@ep-billowing-pond-ai1o1ral-pooler.c-4.us-east-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require"
npm run db:migrate
npm run start
```

## Troubleshooting

- `DB not ready: missing tables: ...`:
  - Run `npm run db:migrate` with the correct `DATABASE_URL`.
- `DB not ready: connect ECONNREFUSED` or TLS/auth errors:
  - Verify Neon URL, SSL params, and Secret Manager value.
- `/healthz` works but `/api/*` returns `503`:
  - Expected until DB readiness check succeeds.
