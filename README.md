# taste-to-lead

## Project structure

- `client/`: React + Vite + Tailwind frontend
- `server/`: Express API + server bootstrap
- `shared/`: Drizzle schema/types shared across app
- `migrations/`: SQL migrations generated by Drizzle
- `script/build.ts`: production build script outputting `dist/`

## Why Cloud Run crashed with `relation "organizations" does not exist`

The app was starting with DB queries (`seedDatabase`) before the HTTP server listened, and schema changes were not tracked by deterministic SQL migrations. In a fresh Neon DB, tables such as `organizations` did not exist yet, so startup crashed before Cloud Run saw a listening process.

This repo now uses Drizzle migration files in `migrations/` and a startup flow that always listens first, then checks DB readiness in the background.

## Drizzle migration workflow

Set only `DATABASE_URL` and run:

```bash
npm run db:generate   # generate SQL migration files from shared/schema.ts
npm run db:migrate    # apply generated migrations to DATABASE_URL
npm run db:studio     # optional local inspection UI
```

## Neon setup (exact commands)

```bash
export DATABASE_URL="postgresql://neondb_owner:npg_6OJSMPBGA1la@ep-billowing-pond-ai1o1ral-pooler.c-4.us-east-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require"
npm run db:migrate
```

## Verify tables exist

Use either Drizzle Studio:

```bash
npm run db:studio
```

Or SQL (example with `psql`):

```bash
psql "$DATABASE_URL" -c "\dt"
psql "$DATABASE_URL" -c "select count(*) from organizations;"
```

## Production startup behavior

- Server listens quickly on `0.0.0.0:${PORT:-8080}`.
- `GET /healthz` returns `200` immediately without DB.
- If DB is unavailable or migrations are missing, the app logs `DB not ready: ...` and API routes return `503` JSON until ready.

## Deployment pipeline

`cloudbuild.yaml` builds and pushes two images per commit:

- Service image: `${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_SERVICE_NAME}:$COMMIT_SHA`
- Migration image: `${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/${_SERVICE_NAME}:migrate-$COMMIT_SHA`

The service deploy uses the service image only. Migrations run separately through a Cloud Run Job that uses the migration image.

## Cloud Run Job setup for migrations (exact commands)

Set your variables:

```bash
export PROJECT_ID="<your-gcp-project>"
export REGION="us-central1"
export REPOSITORY="cloud-run-source-deploy"
export SERVICE_NAME="taste-to-lead"
export COMMIT_SHA="<commit-sha-to-migrate>"
export MIGRATE_IMAGE="${REGION}-docker.pkg.dev/${PROJECT_ID}/${REPOSITORY}/${SERVICE_NAME}:migrate-${COMMIT_SHA}"
```

Create (or update) the Cloud Run Job:

```bash
gcloud run jobs deploy taste-to-lead-migrate \
  --project="$PROJECT_ID" \
  --region="$REGION" \
  --image="$MIGRATE_IMAGE" \
  --set-secrets=DATABASE_URL=DATABASE_URL:latest \
  --max-retries=1 \
  --task-timeout=10m
```

Execute the migration job:

```bash
gcloud run jobs execute taste-to-lead-migrate \
  --project="$PROJECT_ID" \
  --region="$REGION" \
  --wait
```

Describe the latest run:

```bash
gcloud run jobs executions list \
  --project="$PROJECT_ID" \
  --region="$REGION" \
  --job=taste-to-lead-migrate
```

## Local verification commands

```bash
npm ci
npm run build
export DATABASE_URL="postgresql://neondb_owner:npg_6OJSMPBGA1la@ep-billowing-pond-ai1o1ral-pooler.c-4.us-east-1.aws.neon.tech/neondb?sslmode=require&channel_binding=require"
npm run db:migrate
npm run start
```

## Troubleshooting

- `DB not ready: missing tables: ...`:
  - Run `npm run db:migrate` with the correct `DATABASE_URL`.
- `DB not ready: connect ECONNREFUSED` or TLS/auth errors:
  - Verify Neon URL, SSL params, and Secret Manager value.
- `/healthz` works but `/api/*` returns `503`:
  - Expected until DB readiness check succeeds.
